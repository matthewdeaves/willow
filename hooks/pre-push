#!/bin/bash

# This hook script runs code quality checks before allowing a push.
# If any checks fail, the push is aborted.

# Function to determine if sudo is needed
needs_sudo() {
    if [ "$OS" = "Linux" ]; then
        echo "sudo"
    else
        echo ""
    fi
}

echo "=== Pre-push Code Quality Checks ==="

# Step 1: Run PHP CodeSniffer check
echo "Running PHP CodeSniffer check..."
$(needs_sudo) docker compose exec -T willowcms vendor/bin/phpcs --standard=vendor/cakephp/cakephp-codesniffer/CakePHP src/ tests/

# Check the exit status of PHP CodeSniffer
if [ $? -ne 0 ]; then
    echo ""
    echo "‚ùå PHP CodeSniffer found coding standard violations."
    echo "   Run 'phpcs_fix' to auto-fix issues, then stage and commit the changes."
    echo "   Aborting push."
    exit 1
fi

echo "‚úÖ PHP CodeSniffer checks passed."

# Step 2: Run PHPUnit tests
echo "Running PHPUnit tests..."
$(needs_sudo) docker compose exec -T willowcms php vendor/bin/phpunit

# Check the exit status of PHPUnit
if [ $? -ne 0 ]; then
    echo ""
    echo "‚ùå PHPUnit tests failed. Aborting push."
    exit 1
fi

echo "‚úÖ PHPUnit tests passed."
echo ""
echo "üéâ All code quality checks passed. Proceeding with push."

# Continue with the push
exit 0